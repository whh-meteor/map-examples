<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox Terrain Demo</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script type="module">
        import * as maptalks from 'https://esm.sh/maptalks';
        import { GroupGLLayer } from 'https://esm.sh/@maptalks/gl';
        import { getTileActor } from 'https://esm.sh/maptalks.tileclip';

        const map = new maptalks.Map("map", {
            center: [120.3826, 36.0671],
            zoom: 12,
            pitch: 60,
            bearing: 0,
        
        });
        let baseLayer=new maptalks.TileLayer("base", {
                urlTemplate: "https://webst01.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}",
                subdomains: ["a", "b", "c", "d"],
            })
        const colors = [
            [0, "#F0F9E9"],
            [200, "#D7EFD1"],
            [400, "#A6DCB6"],
            [650, "#8FD4BD"],
            [880, "#67C1CB"],
            [1100, "#3C9FC8"],
            [1300, "#1171B1"],
            [1450, "#085799"],
            [1600, "#084586"],
        ];

        const terrain = {
            type: "mapbox",
            maxAvailableZoom: 14,
            requireSkuToken: false,
            urlTemplate: "https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer/tile/{z}/{y}/{x}",
            subdomains: ["a", "b", "c", "d"],
           // colors: colors,
            exaggeration: 3,
            depthMask: true,
           // shader: 'lit',
        };

        const group = new GroupGLLayer("group", [baseLayer], {
            terrain,
        });

        group.on("terrainlayercreated", (e) => {
            const terrainLayer = group.getTerrainLayer();
            const tileActor = getTileActor();

            terrainLayer.getRenderer().loadTileBitmap = (url, tile, callback) => {
                const absoluteUrl = maptalks.Util.getAbsoluteURL(url);
                console.log("Loading terrain tile:", absoluteUrl);

                tileActor
                    .encodeTerrainTile({
                        url: absoluteUrl,
                        terrainType: "arcgis",
                        indexedDBCache: true,
                        fetchOptions: {
                            headers: {
                                'Accept': 'image/png, image/jpeg, image/webp'
                            }
                        }
                    })
                    .then((imagebitmap) => {
                        console.log("Terrain tile encoded successfully");
                        callback(null, imagebitmap);
                    })
                    .catch((error) => {
                        console.error("地形编码失败:", error);
                        console.error("Error details:", error.message, error.stack);
                        callback(error);
                    });
            };
        });

        map.setView({
            center: [120.3826, 36.0671],
            zoom: 12,
            pitch: 60,
            bearing: 0,
        }); group.addTo(map);
        

    </script>
</body>
</html>