<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Map - 3D Buildings with Tower</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dat.gui@0.7.6/build/dat.gui.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maptalks/dist/maptalks.css">
<style type="text/css">
  html, body {
    margin: 0;
    height: 100%;
    width: 100%
  }
  .container {
    width: 100%;
    height: 100%
  }
</style>
<body>

<div id="map" class="container"></div>
<script src="https://cdn.jsdelivr.net/npm/maptalks/dist/maptalks.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.110.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/maptalks.three@0.27.0/dist/maptalks.three.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.110.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="../demos/3d-buildings/GeoCity.js"></script>
<script src="../demos/3d-buildings/BreathPulse.js"></script>
<script src="../demos/3d-buildings/CirclePulse.js"></script>
<script src="../demos/3d-buildings/CircleLight.js"></script>
<script>
  const map = new maptalks.Map('map', {
    zoom: 15,
    center: [120.2197, 35.9437],
    baseLayer: new maptalks.TileLayer('base', {
      urlTemplate: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
      subdomains: ['a', 'b', 'c', 'd'],
  
    })
  });

  const threeLayer = new maptalks.ThreeLayer('t');
  threeLayer.prepareToDraw = function(gl, scene, camera) {
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(0, -10, 10);
    scene.add(light);
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambientLight);
     const groundGeometry = new THREE.PlaneGeometry(10000, 10000);
    const groundMaterial = new THREE.MeshPhongMaterial({
      color: 0x333333,
      side: THREE.DoubleSide,
      transparent: true,
      opacity: 0.5
    });
    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
    ground.rotation.x = -Math.PI / 2;
    ground.position.z = 0;
    scene.add(ground);
   
  };
  threeLayer.addTo(map);

  const gltfLoader = new THREE.GLTFLoader();

  const mapApp = {
    threeLayer: threeLayer,
    gltfLoader: gltfLoader,
    addThing: function(options) {
      const topic = {
        name: options.name,
        onPrepare: options.onPrepare,
        onShow: options.onShow,
        onAdd: options.onAdd,
        onHide: options.onHide,
        setData: null
      };
      
      if (topic.onPrepare) {
        topic.onPrepare(topic, this);
      }
      
      if (topic.onAdd) {
        topic.onAdd(topic, this);
      }
      
      return topic;
    }
  };

  let initThreeTopic = function(mapApp) {
    return mapApp.addThing({
      name: "å«å£«åœºæ™¯",
      onPrepare: (topic, app) => {
        topic.geoCity = new GeoCity(
          {
            levelHight: 10
          },
          app.threeLayer,
          function onClick(evt, prop) {
            let a = prop;
          }
        );
        topic.circleLight = new CircleLight(app);
        topic.setData = function(buildings, data) {
          console.log("ðŸš€ ~ initThreeTopic ~ buildings:", buildings);
          topic.geoCity.setData(buildings);
          topic.circleLight.setData({
            center: [data.longitude, data.latitude],
            lightHeight: data.height || 100,
            lightLength: data.width || 1000
          });
        };
      },
      onShow: (topic, app) => {
        console.log("ðŸš€ ~ initThreeTopic ~ topic:", topic);
        console.log("ðŸš€ ~ onShow ~ topic.circleLight.visible:", topic.circleLight.visible);
        console.log("ðŸš€ ~ onShow ~ topic.circleLight.spotLight:", topic.circleLight.spotLight);
        console.log("ðŸš€ ~ onShow ~ topic.circleLight.spotLightHelper:", topic.circleLight.spotLightHelper);
        topic.geoCity.show();
        topic.circleLight.show();
        console.log("ðŸš€ ~ onShow ~ after show ~ topic.circleLight.visible:", topic.circleLight.visible);
      },
      onAdd: (topic, app) => {},
      onHide: (topic, app) => {
        topic.geoCity.hide();
        topic.circleLight.hide();
      }
    });
  };

  const topic = initThreeTopic(mapApp);

  fetch('../demos/3d-buildings/aqh.json')
    .then(response => response.json())
    .then(data => {
      topic.setData([data], {
        longitude: 120.2137,
        latitude: 35.9437,
        height: 1,  // ç¯å…‰é«˜åº¦
        width: 1000
      });
      setTimeout(() => {
        topic.geoCity.show();
        topic.circleLight.show();
      }, 1000);
    })
    .catch(error => console.error('Error loading buildings:', error));

  threeLayer.config('animation', true);

</script>
</body>
</html>
